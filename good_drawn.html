<!doctype html>
<html>
<head>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/mousetrap/1.4.5/mousetrap.js"></script>
  <script src="http://rawgithub.com/sole/tween.js/r12/build/tween.min.js"></script>
  <script src="http://threejs.org/build/three.js"></script>
  <script src="http://threejs.org/examples/js/controls/TrackballControls.js"></script>
  <script src="http://threejs.org/examples/js/renderers/CSS3DRenderer.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js"></script>
  <script src="http://mohayonao.github.io/pico.js/misc/jquery.min.js"></script>
  <script src="src/timble.js"></script>
  
  <style>
    * { margin: 0; padding: 0; }
    body {
      font-family: 'Helvetica Neue';
      font-size: .8em;
      background-color: #333;
      /*background-image: url(http://radiatinglight.files.wordpress.com/2011/06/golden-rays.jpg);
      */
      background-image: url(http://www.freefever.com/stock/new-earth-space-pictures-images.jpg);
      background-size: cover;
    }
    .controls {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 10;
      background-color: rgba(0, 0, 0, .4);
      padding: 1em;
      color: #fff;
    }
    .controls:hover {
      background-color: rgba(0, 0, 0, .6);
    }
  </style>
</head>
<body>
 
<div class="controls">
  <input type="checkbox" id="3d">
  <label for="3d">3D Mode</label>
</div>
 
<script>
 
var is3D = false;
var checkbox = document.querySelector('[type=checkbox]');
 
checkbox.onchange = function(e) {
  if (e.target.checked) {
    enter3DMode();
  } else {
    exit3DMode();
  }
};
 
var margin = 0;
var fov = 75;
var scene = new THREE.Scene();
 
var aspect = window.innerHeight / window.innerWidth;
var camera = new THREE.PerspectiveCamera(fov, 1, 1, 100000);
var defaultZ = camera.position.z = (window.innerWidth * 0.5) / Math.tan(fov * 0.5 * 0.01745) * aspect;
 
var renderer = new THREE.CSS3DRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.domElement.style.position = 'absolute';
document.body.appendChild(renderer.domElement);
 
var controls = new THREE.TrackballControls(camera, renderer.domElement);
controls.rotateSpeed = 0.5;
// controls.addEventListener('change', render);
 
var iframe = document.createElement('iframe');
iframe.src = 'http://uniba.jp';
var aspect = window.innerWidth / window.innerHeight;
iframe.width = window.innerWidth - margin;
iframe.height = window.innerHeight - margin;
iframe.setAttribute('frameborder', 0);
 
var object = new THREE.CSS3DObject(iframe);
scene.add(object);
 
var lastPosition = new THREE.Vector3(0, 0, 1000);
var lastRotation = new THREE.Euler(0, 0, 0);
 
function enter3DMode() {
  is3D = true;
 
  var posTween = new TWEEN.Tween(camera.position);
  var rotTween = new TWEEN.Tween(camera.rotation);
 
  posTween
  .to(lastPosition, 1000)
  .easing(TWEEN.Easing.Elastic.Out)
  .start();
 
  rotTween
  .to({ x: lastRotation.x, y: lastRotation.y, z: lastRotation.z }, 1000)
  .easing(TWEEN.Easing.Elastic.Out)
  .start();  
}
 
function exit3DMode() {
  is3D = false;
 
  lastPosition = camera.position.clone();
  lastRotation = camera.rotation.clone();
 
  var posTween = new TWEEN.Tween(camera.position);
  var rotTween = new TWEEN.Tween(camera.rotation);
 
  posTween
  .to({ x: 0, y: 0, z: defaultZ }, 1000)
  .easing(TWEEN.Easing.Exponential.Out)
  .start();
 
  rotTween
  .to({ x: 0, y: 0, z: 0 }, 1000)
  .easing(TWEEN.Easing.Exponential.Out)
  .start();
}
 
requestAnimationFrame(function() {
  requestAnimationFrame(arguments.callee);
  if (is3D) controls.update();
  TWEEN.update();
  renderer.render(scene, camera);
});




/*---------------------------------------------------*/


(function() { 

  // グローバルな変数
  var oscMelo;
  var oscMelo2;
  var drawnNum = 120;
  var oscDrawn = new Array(drawnNum);
  var oscDrawnOriginFreq = new Array(drawnNum);
  
  var intervalArray = new Array(drawnNum);
  var intervalArrayOriginTime = new Array(drawnNum);
  
  var filterArray = new Array(drawnNum);
  var filterOriginFreq = new Array(drawnNum);


  //
  // setup関数
  //
  function timbleInit() {

    for(var i = 0; i < drawnNum; ++i) { 
      oscDrawn[i] = T("saw",{freq: mtof(airNotation()) + Math.random()*4, mul:0.02});
      oscDrawnOriginFreq[i] = oscDrawn[i].freq.value;

      /*sawオシレーターかけてローパスかけたらいい感じに*/
      filterArray[i] = T("lpf" , {cutoff:400 + (Math.random()*100), Q:12}, oscDrawn[i]).play();
      filterOriginFreq[i] = filterArray[i].freq.value;
    }

    
  }

  function mtof(val) {
    return Math.floor(440*Math.pow(2, (val-69)/12));
  }


  function ftom(frequency) {
    return(69+12*Math.log(frequency/440)/Math.log(2))
  }

  function scaleTonal(freq) {
    return mtof(parseInt(ftom(freq) ) ) 
  }

  function  airNotation(coef) {
     if(typeof coef === 'undefined') coef = 5;
    return Math.floor(Math.random()*25) * coef
  }

  function  cm75Notation() {
    var target = Math.floor(Math.random()*4)
    var randOct = Math.floor(Math.random()*5) * 12
    return ( [0, 4, 8, 11][target] + randOct )
  }



    
  timbleInit();
    

  renderer.domElement.addEventListener('mousewheel', function(e){
    var z_val = camera.position.z;   
    var sin_val = Math.sin(z_val * 0.001);

    for(var count = 0; count < drawnNum; ++count) { 
      oscDrawn[count].freq.value = (sin_val * 4) + oscDrawnOriginFreq[count];
      filterArray[count].freq.value = (sin_val * 300) + filterOriginFreq[count];
    }

  })



  //動いてない
  renderer.domElement.addEventListener('drag', function(e){
    console.log("aaaaa");
  })





})();



 
</script>
 
</body>
</html>